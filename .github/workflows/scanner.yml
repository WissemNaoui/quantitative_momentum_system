name: Daily Scanner

on:
  schedule:
    # Run every weekday at 9:00 AM UTC (before market open)
    - cron: '0 9 * * 1-5'
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Run scanner
      env:
        FD_API_KEY: ${{ secrets.FD_API_KEY }}
        FINVIZ_API_TOKEN: ${{ secrets.FINVIZ_API_TOKEN }}
      run: |
        python -m src.scanner
    
    - name: Parse results
      id: parse
      run: |
        # Get the latest picks file
        PICKS_FILE=$(ls -t picks_*.csv | head -1)
        
        # Count picks
        PICK_COUNT=$(wc -l < "$PICKS_FILE")
        echo "pick_count=$PICK_COUNT" >> $GITHUB_OUTPUT
        
        # Get top 3 tickers
        TOP_PICKS=$(tail -n +2 "$PICKS_FILE" | head -3 | cut -d',' -f1 | tr '\n' ',' | sed 's/,$//')
        echo "top_picks=$TOP_PICKS" >> $GITHUB_OUTPUT
    
    - name: Upload picks
      uses: actions/upload-artifact@v4
      with:
        name: daily-picks-${{ github.run_number }}
        path: picks_*.csv
        retention-days: 90
    
    - name: Create scan summary
      run: |
        echo "## ðŸŽ¯ Daily Stock Picks" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
        echo "**Picks Found:** ${{ steps.parse.outputs.pick_count }}" >> $GITHUB_STEP_SUMMARY
        echo "**Top 3:** ${{ steps.parse.outputs.top_picks }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Download full results from artifacts above." >> $GITHUB_STEP_SUMMARY
    
    - name: Send notification (optional)
      if: steps.parse.outputs.pick_count > 0
      run: |
        echo "ðŸ“§ Send email/Slack notification with picks here"
        # Example: curl -X POST $SLACK_WEBHOOK -d "{'text':'New picks: ${{ steps.parse.outputs.top_picks }}'}"
